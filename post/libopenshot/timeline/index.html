<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>libopenshot-Timeline和Clip中的Frame合成 - Teoking writes something.</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="teoking" /><meta name="description" content="在《libopenshot-基本概念以及播放器实现》一文中，其中一个示例是两个clip操作的展示，我们实现了在视频画面之上显示一张静态图片。" /><meta name="keywords" content="Tech, Android, iOS" />






<meta name="generator" content="Hugo 0.99.1 with theme even" />


<link rel="canonical" href="https://teoking.github.io/post/libopenshot/timeline/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="libopenshot-Timeline和Clip中的Frame合成" />
<meta property="og:description" content="在《libopenshot-基本概念以及播放器实现》一文中，其中一个示例是两个clip操作的展示，我们实现了在视频画面之上显示一张静态图片。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://teoking.github.io/post/libopenshot/timeline/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-08-02T15:28:28+08:00" />
<meta property="article:modified_time" content="2021-08-02T15:28:28+08:00" />

<meta itemprop="name" content="libopenshot-Timeline和Clip中的Frame合成">
<meta itemprop="description" content="在《libopenshot-基本概念以及播放器实现》一文中，其中一个示例是两个clip操作的展示，我们实现了在视频画面之上显示一张静态图片。"><meta itemprop="datePublished" content="2021-08-02T15:28:28+08:00" />
<meta itemprop="dateModified" content="2021-08-02T15:28:28+08:00" />
<meta itemprop="wordCount" content="4278">
<meta itemprop="keywords" content="C&#43;&#43;,libopenshot,video-editing,video-processing,video-effects," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="libopenshot-Timeline和Clip中的Frame合成"/>
<meta name="twitter:description" content="在《libopenshot-基本概念以及播放器实现》一文中，其中一个示例是两个clip操作的展示，我们实现了在视频画面之上显示一张静态图片。"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Teoking</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Teoking</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">libopenshot-Timeline和Clip中的Frame合成</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-08-02 </span>
        <div class="post-category">
            <a href="/categories/av/"> AV </a>
            </div>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#timeline-clip中的frame合成">Timeline, Clip中的Frame合成</a>
      <ul>
        <li><a href="#两个clip的frame合成过程">两个Clip的Frame合成过程</a>
          <ul>
            <li><a href="#1-创建timeline对象">1. 创建Timeline对象</a></li>
            <li><a href="#2创建reader和clip对象">2.创建reader和clip对象</a></li>
            <li><a href="#3-设置clip对象">3. 设置Clip对象</a></li>
            <li><a href="#4-添加clip到timeline">4. 添加Clip到Timeline</a></li>
            <li><a href="#5-设置timeline为open状态">5. 设置Timeline为open状态</a></li>
            <li><a href="#6-显示第一帧到屏幕">6. 显示第一帧到屏幕</a></li>
            <li><a href="#7-关闭timeline">7. 关闭Timeline</a></li>
          </ul>
        </li>
        <li><a href="#帧合成">帧合成</a>
          <ul>
            <li><a href="#帧合成过程">帧合成过程</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#总结">总结</a></li>
    <li><a href="#参考资料">参考资料</a></li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>在<a href="../concept-and-player-impl">《libopenshot-基本概念以及播放器实现》</a>一文中，其中一个示例是<a href="../concept-and-player-impl/#%E4%B8%A4%E4%B8%AAclip%E6%93%8D%E4%BD%9C">两个clip操作</a>的展示，我们实现了在视频画面之上显示一张静态图片。这个例子算是Timeline和Clip的基本使用，本文就来分析一下这两个类的实现。</p>
<h1 id="timeline-clip中的frame合成">Timeline, Clip中的Frame合成</h1>
<h2 id="两个clip的frame合成过程">两个Clip的Frame合成过程</h2>
<p>以<code>两个clip操作</code>代码为例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">testTwoClips</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 1. Create a Timeline
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Timeline</span> <span class="n">t</span><span class="p">(</span><span class="mi">1280</span><span class="p">,</span> <span class="c1">// width
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>               <span class="mi">720</span><span class="p">,</span> <span class="c1">// height
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>               <span class="n">Fraction</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="c1">// framerate
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>               <span class="mi">44100</span><span class="p">,</span> <span class="c1">// sample rate
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>               <span class="mi">2</span><span class="p">,</span> <span class="c1">// channels
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>               <span class="n">ChannelLayout</span><span class="o">::</span><span class="n">LAYOUT_STEREO</span>
</span></span><span class="line"><span class="cl">               <span class="p">);</span>
</span></span><span class="line"><span class="cl">     
</span></span><span class="line"><span class="cl">    <span class="c1">// 2. Create some clips
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">const</span> <span class="k">auto</span> <span class="n">imageReader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ImageReader</span><span class="p">(</span><span class="n">IMAGE_PATH</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="k">auto</span> <span class="n">ffmpegReader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FFmpegReader</span><span class="p">(</span><span class="n">VIDEO_PATH</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Clip</span> <span class="n">c1</span><span class="p">(</span><span class="n">imageReader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Clip</span> <span class="n">c2</span><span class="p">(</span><span class="n">ffmpegReader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;ImageReader  video_length: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">imageReader</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">video_length</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;FFmpegReader video_length: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">ffmpegReader</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">video_length</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">     
</span></span><span class="line"><span class="cl">    <span class="c1">// 3.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// CLIP 1 (logo) - Set some clip properties (with Keyframes)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">c1</span><span class="p">.</span><span class="n">Position</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span> <span class="c1">// Set the position or location (in seconds) on the timeline
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">c1</span><span class="p">.</span><span class="n">gravity</span> <span class="o">=</span> <span class="n">GRAVITY_LEFT</span><span class="p">;</span> <span class="c1">// Set the alignment / gravity of the clip (position on the screen)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">c1</span><span class="p">.</span><span class="n">scale</span> <span class="o">=</span> <span class="n">SCALE_CROP</span><span class="p">;</span> <span class="c1">// Set the scale mode (how the image is resized to fill the screen)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">c1</span><span class="p">.</span><span class="n">Layer</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="c1">// Set the layer of the timeline (higher layers cover up images of lower layers)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">c1</span><span class="p">.</span><span class="n">Start</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span> <span class="c1">// Set the starting position of the video (trim the left side of the video)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">c1</span><span class="p">.</span><span class="n">End</span><span class="p">(</span><span class="mf">16.0</span><span class="p">);</span> <span class="c1">// Set the ending position of the video (trim the right side of the video)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">c1</span><span class="p">.</span><span class="n">scale_x</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">c1</span><span class="p">.</span><span class="n">scale_y</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">c1</span><span class="p">.</span><span class="n">location_x</span> <span class="o">=</span> <span class="mf">0.33</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">     
</span></span><span class="line"><span class="cl">    <span class="c1">// CLIP 2 (background video) - Set some clip properties (with Keyframes)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">c2</span><span class="p">.</span><span class="n">Position</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span> <span class="c1">// Set the position or location (in seconds) on the timeline
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">c2</span><span class="p">.</span><span class="n">Start</span><span class="p">(</span><span class="mf">10.0</span><span class="p">);</span> <span class="c1">// Set the starting position of the video (trim the left side of the video)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">c2</span><span class="p">.</span><span class="n">Layer</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="c1">// Set the layer of the timeline (higher layers cover up images of lower layers)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     
</span></span><span class="line"><span class="cl">    <span class="c1">// 4. Add clips to timeline
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">t</span><span class="p">.</span><span class="n">AddClip</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">t</span><span class="p">.</span><span class="n">AddClip</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">     
</span></span><span class="line"><span class="cl">    <span class="c1">// 5. Open the timeline reader
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">t</span><span class="p">.</span><span class="n">Open</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Get frame number 1 from the timeline (This will generate a new frame, made up from the previous clips and settings)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Frame</span><span class="o">&gt;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="n">GetFrame</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 6. Now that we have an openshot::Frame object, lets have some fun!
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">f</span><span class="o">-&gt;</span><span class="n">Display</span><span class="p">();</span> <span class="c1">// Display the frame on the screen
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     
</span></span><span class="line"><span class="cl">    <span class="c1">// 7. Close the timeline reader
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">t</span><span class="p">.</span><span class="n">Close</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>初始化过程分为7步：</p>
<ol>
<li>创建Timeline对象</li>
<li>创建reader和clip对象</li>
<li>设置Clip对象</li>
<li>添加Clip到Timeline</li>
<li>设置Timeline为open状态</li>
<li>显示第一帧到屏幕</li>
<li>关闭Timeline</li>
</ol>
<h3 id="1-创建timeline对象">1. 创建Timeline对象</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// Default Constructor for the timeline (which sets the canvas width and height)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">Timeline</span><span class="o">::</span><span class="n">Timeline</span><span class="p">(</span><span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">height</span><span class="p">,</span> <span class="n">Fraction</span> <span class="n">fps</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sample_rate</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channels</span><span class="p">,</span> <span class="n">ChannelLayout</span> <span class="n">channel_layout</span><span class="p">)</span> <span class="o">:</span>
</span></span><span class="line"><span class="cl">		<span class="n">is_open</span><span class="p">(</span><span class="nb">false</span><span class="p">),</span> <span class="n">auto_map_clips</span><span class="p">(</span><span class="nb">true</span><span class="p">),</span> <span class="n">managed_cache</span><span class="p">(</span><span class="nb">true</span><span class="p">),</span> <span class="n">path</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="n">max_concurrent_frames</span><span class="p">(</span><span class="n">OPEN_MP_NUM_PROCESSORS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Create CrashHandler and Attach (incase of errors)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">CrashHandler</span><span class="o">::</span><span class="n">Instance</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Init viewport size (curve based, because it can be animated)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">viewport_scale</span> <span class="o">=</span> <span class="n">Keyframe</span><span class="p">(</span><span class="mf">100.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">viewport_x</span> <span class="o">=</span> <span class="n">Keyframe</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">viewport_y</span> <span class="o">=</span> <span class="n">Keyframe</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Init background color
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">color</span><span class="p">.</span><span class="n">red</span> <span class="o">=</span> <span class="n">Keyframe</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">color</span><span class="p">.</span><span class="n">green</span> <span class="o">=</span> <span class="n">Keyframe</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">color</span><span class="p">.</span><span class="n">blue</span> <span class="o">=</span> <span class="n">Keyframe</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Init FileInfo struct (clear all values)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">info</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">width</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">info</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">height</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">preview_width</span> <span class="o">=</span> <span class="n">info</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">preview_height</span> <span class="o">=</span> <span class="n">info</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">info</span><span class="p">.</span><span class="n">fps</span> <span class="o">=</span> <span class="n">fps</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">info</span><span class="p">.</span><span class="n">sample_rate</span> <span class="o">=</span> <span class="n">sample_rate</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">info</span><span class="p">.</span><span class="n">channels</span> <span class="o">=</span> <span class="n">channels</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">info</span><span class="p">.</span><span class="n">channel_layout</span> <span class="o">=</span> <span class="n">channel_layout</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">info</span><span class="p">.</span><span class="n">video_timebase</span> <span class="o">=</span> <span class="n">fps</span><span class="p">.</span><span class="n">Reciprocal</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="n">info</span><span class="p">.</span><span class="n">duration</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">30</span><span class="p">;</span> <span class="c1">// 30 minute default duration
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">info</span><span class="p">.</span><span class="n">has_audio</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">info</span><span class="p">.</span><span class="n">has_video</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">info</span><span class="p">.</span><span class="n">video_length</span> <span class="o">=</span> <span class="n">info</span><span class="p">.</span><span class="n">fps</span><span class="p">.</span><span class="n">ToFloat</span><span class="p">()</span> <span class="o">*</span> <span class="n">info</span><span class="p">.</span><span class="n">duration</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">info</span><span class="p">.</span><span class="n">display_ratio</span> <span class="o">=</span> <span class="n">openshot</span><span class="o">::</span><span class="n">Fraction</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">info</span><span class="p">.</span><span class="n">display_ratio</span><span class="p">.</span><span class="n">Reduce</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="n">info</span><span class="p">.</span><span class="n">pixel_ratio</span> <span class="o">=</span> <span class="n">openshot</span><span class="o">::</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">info</span><span class="p">.</span><span class="n">acodec</span> <span class="o">=</span> <span class="s">&#34;openshot::timeline&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">info</span><span class="p">.</span><span class="n">vcodec</span> <span class="o">=</span> <span class="s">&#34;openshot::timeline&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Init cache
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">final_cache</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CacheMemory</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Init max image size
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">SetMaxSize</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这个默认构造器主要在设置以下几类信息：</p>
<ul>
<li>画布属性：viewport, background color, preview width/size</li>
<li>设置reader info，它表示当前媒体文件的信息</li>
<li>初始化cache，当前实现是内存cache</li>
<li>设置最大画面尺寸</li>
</ul>
<h3 id="2创建reader和clip对象">2.创建reader和clip对象</h3>
<p>这一步主要是创建了两个reader，以及使用它们分别创建两个Clip对象，再设置clip对象的属性。</p>
<p>ImageReader使用ImageMagick解码图片文件，返回Frame对象</p>
<p>FFmpegReader使用FFmpeg来解码视频文件，返回Frame对象</p>
<p>Clip表示<strong>一个可编辑的片段</strong>，其内容可以是视频、图片，所有的编辑操作都作用到它</p>
<p>Frame表示<strong>视频的一帧</strong>，包含图像和声音数据。它是视频编辑中最小单元。</p>
<p>Clip的构造函数：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// Constructor with reader
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">Clip</span><span class="o">::</span><span class="n">Clip</span><span class="p">(</span><span class="n">ReaderBase</span><span class="o">*</span> <span class="n">new_reader</span><span class="p">)</span> <span class="o">:</span> <span class="n">resampler</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span> <span class="n">reader</span><span class="p">(</span><span class="n">new_reader</span><span class="p">),</span> <span class="n">allocated_reader</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span> <span class="n">is_open</span><span class="p">(</span><span class="nb">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Init all default settings
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">init_settings</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Open and Close the reader (to set the duration of the clip)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">Open</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="n">Close</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Update duration and set parent
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="n">reader</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">End</span><span class="p">(</span><span class="n">reader</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">duration</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">reader</span><span class="o">-&gt;</span><span class="n">ParentClip</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Init reader info struct
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">init_reader_settings</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>从这里可以看出，clip是reader的使用者，它消费reader中的数据。</p>
<h3 id="3-设置clip对象">3. 设置Clip对象</h3>
<p>clip拥有很多属性，通过<strong>设置这些属性就可以实现对clip的编辑。</strong>（具体属性参见：<code>Clip.h</code>）</p>
<h3 id="4-添加clip到timeline">4. 添加Clip到Timeline</h3>
<p>Timeline::AddClip源码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// Add an openshot::Clip to the timeline
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">Timeline</span><span class="o">::</span><span class="n">AddClip</span><span class="p">(</span><span class="n">Clip</span><span class="o">*</span> <span class="n">clip</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Assign timeline to clip
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">clip</span><span class="o">-&gt;</span><span class="n">ParentTimeline</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Clear cache of clip and nested reader (if any)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">clip</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">Clear</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">clip</span><span class="o">-&gt;</span><span class="n">Reader</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">clip</span><span class="o">-&gt;</span><span class="n">Reader</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetCache</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">		<span class="n">clip</span><span class="o">-&gt;</span><span class="n">Reader</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetCache</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">Clear</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// All clips should be converted to the frame rate of this timeline
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="n">auto_map_clips</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Apply framemapper (or update existing framemapper)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">apply_mapper_to_clip</span><span class="p">(</span><span class="n">clip</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Add clip to list
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">clips</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">clip</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Sort clips
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">sort_clips</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>最后的sort_clips的排序函数如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl">	<span class="c1">/// Comparison method for sorting clip pointers (by Layer and then Position). Clips are sorted
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">/// from lowest layer to top layer (since that is the sequence they need to be combined), and then
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">/// by position (left to right).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">struct</span> <span class="nc">CompareClips</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="kt">bool</span> <span class="nf">operator</span><span class="p">()(</span> <span class="n">openshot</span><span class="o">::</span><span class="n">Clip</span><span class="o">*</span> <span class="n">lhs</span><span class="p">,</span> <span class="n">openshot</span><span class="o">::</span><span class="n">Clip</span><span class="o">*</span> <span class="n">rhs</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span><span class="p">(</span> <span class="n">lhs</span><span class="o">-&gt;</span><span class="n">Layer</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">rhs</span><span class="o">-&gt;</span><span class="n">Layer</span><span class="p">()</span> <span class="p">)</span> <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span><span class="p">(</span> <span class="n">lhs</span><span class="o">-&gt;</span><span class="n">Layer</span><span class="p">()</span> <span class="o">==</span> <span class="n">rhs</span><span class="o">-&gt;</span><span class="n">Layer</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">lhs</span><span class="o">-&gt;</span><span class="n">Position</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">rhs</span><span class="o">-&gt;</span><span class="n">Position</span><span class="p">()</span> <span class="p">)</span> <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以总结为：按layer从底到上排序后，再按position从左到右排序</p>
<h3 id="5-设置timeline为open状态">5. 设置Timeline为open状态</h3>
<p>设置当前timeline为open状态</p>
<h3 id="6-显示第一帧到屏幕">6. 显示第一帧到屏幕</h3>
<p>这一步将通过timeline对象读取第一个frame对象，然后将它显示到屏幕上。</p>
<p><code>std::shared_ptr&lt;Frame&gt; Timeline::GetFrame(int64_t requested_frame)</code>允许我们读取指定的frame。</p>
<p>在之前的文章中，我们分析过，一个视频播放器实际上就是以特定帧率逐帧播放音频和视频，配合特定的同步算法和协调代码，就实现了我们看到的“运动的画面以及匹配画面的声音”这样的效果。而这里我们只关注其中一帧数据是如何读取出来的。</p>
<p>读取指定frame的过程：</p>
<ol>
<li>从缓存中取，如果存在，则返回frame</li>
<li>缓存中不存在该frame时：
<ol>
<li>锁定当前线程</li>
<li>再次尝试从缓存中获取（考虑到线程同步的影响），如果取到就返回该frame</li>
<li>从缓存中查找前一个frame，如果不存在该frame，说明是seek到了timeline上新的位置，这时候缓存的连续的帧都应该失效了，这里将缓存都清除（从这里可以看出，frame的缓存是线性且连续的）</li>
<li>创建空白frame，用已知属性进行设置</li>
<li>找到相交的clip（OpenShot允许clip相交，但移动端的app多数不允许clip相交），相交指的是该时间点上有多个clip</li>
<li>根据相交的clip生成frame（<em><strong>这一过程较为复杂，放在<a href="#%E5%B8%A7%E5%90%88%E6%88%90">“帧合成”</a>这一节来单独分析</strong></em>）</li>
<li>保存新的frame进cache，再从cache中获取该frame（这一步并非多次一举，因为frame并不一定会被马上消费掉，放入cache以备后续再用）</li>
</ol>
</li>
<li>渲染该frame到屏幕</li>
</ol>
<h3 id="7-关闭timeline">7. 关闭Timeline</h3>
<p>关闭timeline，同时清除缓存、关闭clips</p>
<h2 id="帧合成">帧合成</h2>
<p>我们先来看一下Timeline文档中的一段：</p>
<p><img src="../timeline_doc1.png" alt="Clip Composite"></p>
<p>从这一张图，我们可以解读出以下几点：</p>
<ul>
<li>Viewport是用户看到的画面区域</li>
<li>Canvas是画面的绘制区域，尺寸在创建是指定</li>
<li>Layer表示具体的画面单元
<ul>
<li>Layer有层级关系，如图Layer 1位于最底层，Layer2, 3位于Layer 1上层</li>
<li>Layer有位置关系，比如Layer2, 3相邻，分别占据画布的左侧和右侧</li>
</ul>
</li>
<li>Viewport、Canvas、Layer协作，最终展示给用户的，是由多个Layer合成出来的画面</li>
</ul>
<p><img src="../timeline_doc2.png" alt="Frame Composite"></p>
<p>这张图就展示了，多个Layer是如何被合成的：当播放到第5帧时，Layer 3中第3帧和Layer 2中的第9帧被拿出来，合成为新的帧。</p>
<p>上述过程就可以称为帧合成。</p>
<h3 id="帧合成过程">帧合成过程</h3>
<p>假设当前playhead要播放p位置对应的帧，这一帧的合成过程如下：</p>
<ol>
<li>创建一个空白帧new_frame，其宽、高为预览宽、高</li>
<li>找出与p位置相交的clip（如果p在该clip的起始帧和结束帧之间则相交，代码见<code>Timeline::find_intersecting_clips</code>）</li>
<li>遍历相交clip
<ol>
<li>确认是否是is_top_clip(是否是最底层clip)</li>
<li>计算max_volume</li>
<li>新增layer（将当前clip的frame合成到new_frame，代码见<code>Timeline::add_layer</code>）
<ol>
<li>将当前clip的图像混合到new_frame上（这一过程比较复杂，详见<a href="#%E5%B8%A7%E5%9B%BE%E5%83%8F%E5%90%88%E6%88%90">帧图像合成</a>，代码见<code>Timeline::GetOrCreateFrame</code>）</li>
<li>将当前clip的audio数据混合到new_frame（音频重采样&amp;增益计算，详见<a href="#%E5%B8%A7%E9%9F%B3%E9%A2%91%E5%90%88%E6%88%90">帧音频合成</a>）</li>
</ol>
</li>
</ol>
</li>
<li>返回new_frame</li>
</ol>
<p>经历了上述过程，我们就可以得到一个完整的frame，其包含合成后的图像数据以及重采样后的音频数据。</p>
<h4 id="帧图像合成">帧图像合成</h4>
<p>这一节内容是<em><strong>3.3.1 将当前clip的图像混合到new_frame上</strong></em>的展开。具体过程：</p>
<ol>
<li>
<p>创建新的帧对象(new_frame)，用以接收合成后的帧</p>
</li>
<li>
<p>将原始frame作为background_frame，传入给当前clip去合成</p>
<ol>
<li>
<p>调用Clip::GetOrCreateFrame，从reader中读取对应位置的frame给original_frame（注意这里的frame是下层reader的frame的拷贝，所以后续对像素、声音的修改不会影响reader中的frame）</p>
</li>
<li>
<p>对original_frame进行time map处理（如变速播放、倒放，这时主要是音频会变化）</p>
</li>
<li>
<p>对original_frame应用effects</p>
</li>
<li>
<p>如果当前clip是top clip，此时还要应用timeline中的effects</p>
</li>
<li>
<p>合成original_frame图像到background_frame的图像上（源码见<code>Clip::apply_keyframes</code>）</p>
<ol>
<li>
<p>从original_frame取得QImage对象，给source_image</p>
</li>
<li>
<p>如果是waveform，生成frame的waveform图，给source_image</p>
</li>
<li>
<p>根据frame生成transform（QTransform对象，源码见<code>Clip::get_transform</code>）</p>
<ul>
<li>
<p>处理alpha和opacity</p>
</li>
<li>
<p>处理location, rotation和scale</p>
</li>
</ul>
</li>
<li>
<p>创建painter（QPainter对象）：<code>QPainter painter(background_canvas.get());</code></p>
</li>
<li>
<p>给painter设置render参数：QPainter::Antialiasing | QPainter::SmoothPixmapTransform | QPainter::TextAntialiasing</p>
</li>
<li>
<p>给painter设置transform</p>
</li>
<li>
<p>给painter设置合成模式为QPainter::CompositionMode_SourceOver （新图覆盖与原图之上）</p>
</li>
<li>
<p>将source_image绘制到background_canvas上</p>
</li>
<li>
<p>将background_canvas更新到original_frame</p>
</li>
</ol>
</li>
<li>
<p>返回合成后的original_frame</p>
</li>
</ol>
</li>
<li>
<p>合成结果保存给new_frame</p>
</li>
</ol>
<p>这就是src frame（original frame）和dest frame（background frame）的合成过程。</p>
<h4 id="帧音频合成">帧音频合成</h4>
<p>真音频的合成过程比较清晰，可以简单理解为：将src frame的音频数据混合（mix）到dest frame中。音频处理使用的是<a href="https://github.com/juce-framework/JUCE">JUCE框架</a>实现。</p>
<h1 id="总结">总结</h1>
<p>Timeline, Clip, Frame是libopenshot的核心之一。本文详细解读了一个包含两个Clip的Timeline对象，读取其第一帧并显示到屏幕上的过程。这里比较重要环节是不同Clip中的frame的图像和音频数据是如何合成（混合）到一起的，它是我们理解libopenshot工作原理的基础。</p>
<h1 id="参考资料">参考资料</h1>
<ol>
<li><a href="https://support.apple.com/zh-hk/guide/logicpro/lgcp0f34ca7a/mac">playhead</a>: The playhead is the vertical line showing the current playback position in the Tracks area and other time-based windows (such as the Audio Track Editor, Piano Roll Editor, and Score Editor).</li>
<li><a href="https://doc.qt.io/qt-5/qpainter.html">QPainter</a>: QPainter provides highly optimized functions to do most of the drawing GUI programs require. It can draw everything from simple lines to complex shapes like pies and chords. It can also draw aligned text and pixmaps. Normally, it draws in a &ldquo;natural&rdquo; coordinate system, but it can also do view and world transformation.  可以理解为Android中的Canvas。</li>
<li><a href="https://www.adobepress.com/articles/article.asp?p=2171314&amp;seqNum=2">Audio Gain</a>: 音频增益。增益和音量不同，增益是调节信号强度的，音量是调节整体声音大小的。增益过大，声音就会破音。参考<a href="https://helpx.adobe.com/cn/premiere-pro/using/adjusting-volume-levels.html">Premiere Pro调整增益和音量</a>。</li>
</ol>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">teoking</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2021-08-02
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/c&#43;&#43;/">C&#43;&#43;</a>
          <a href="/tags/libopenshot/">libopenshot</a>
          <a href="/tags/video-editing/">video-editing</a>
          <a href="/tags/video-processing/">video-processing</a>
          <a href="/tags/video-effects/">video-effects</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/libopenshot/effect-transition/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">libopenshot-Effect,KeyFrame和Transition</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/libopenshot/outline/">
            <span class="next-text nav-default">专题-从libopenshot学习视频编辑器</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:yagatong@email.com" class="iconfont icon-email" title="email"></a>
  <a href="https://teoking.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2020 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span>teoking</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.64437849d125a2d603b3e71d6de5225d641a32d17168a58106e0b61852079683.js"></script>








</body>
</html>
